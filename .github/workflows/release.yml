name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (optional, e.g. v1.2.3). If not provided, patch version will auto-increment."
        required: false

jobs:
  create-tag-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release version
        id: version
        shell: bash
        run: |
          VERSION_INPUT="${{ github.event.inputs.version }}"
          LATEST_TAG=$(git tag --list 'v*' --sort=-v:refname | head -n1)

          if [ -n "${VERSION_INPUT}" ]; then
            # Manually provided version
            NEW_VERSION="${VERSION_INPUT}"
            IS_FIRST_RELEASE="false"
          elif [ -z "${LATEST_TAG}" ]; then
            # Auto-incremented, no previous tag found (First Release)
            NEW_VERSION="v1.0.0"
            IS_FIRST_RELEASE="true"
          else
            # Auto-incremented, previous tag found (Standard Release)
            IFS='.' read -r major minor patch <<< "${LATEST_TAG#v}"
            patch=$((patch + 1))
            NEW_VERSION="v${major}.${minor}.${patch}"
            IS_FIRST_RELEASE="false"
          fi
          
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "is_first_release=${IS_FIRST_RELEASE}" >> $GITHUB_OUTPUT
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          
          if [ "${IS_FIRST_RELEASE}" == "true" ]; then
            echo "Identified as First Release: ${NEW_VERSION}"
          else
            echo "Next Version: ${NEW_VERSION}"
          fi

      - name: Generate CHANGELOG (First Release)
        id: changelog_first
        if: steps.version.outputs.is_first_release == 'true'
        run: |
          # Use git log to get all commits since the very beginning
          CHANGELOG_BODY=$(git log --pretty=format:"* %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --reverse)
          # Store the output
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "## New Features and Fixes" >> $GITHUB_OUTPUT
          echo "${CHANGELOG_BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate CHANGELOG (Standard Release)
        id: changelog_standard
        if: steps.version.outputs.is_first_release == 'false'
        uses: metcalfc/changelog-generator@v4
        with:
          mytoken: ${{ secrets.RELEASE_TOKEN }}
          # Use the correct input name and the previous tag
          base-ref: ${{ steps.version.outputs.latest_tag }}
          head-ref: ${{ steps.version.outputs.version }}

      - name: Set Release Body Output
        id: release_body
        run: |
          # Use the output from the step that ran
          if [ "${{ steps.version.outputs.is_first_release }}" == "true" ]; then
            RELEASE_BODY="${{ steps.changelog_first.outputs.changelog }}"
          else
            RELEASE_BODY="${{ steps.changelog_standard.outputs.changelog }}"
          fi
          echo "body=${RELEASE_BODY}" >> $GITHUB_OUTPUT

      - name: Ensure CHANGELOG exists
        run: |
          touch CHANGELOG.md

      - name: Commit and push CHANGELOG
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md
          git commit -m "chore: update CHANGELOG for ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push origin main

      - name: Create tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Build JAR
        run: mvn clean package -DskipTests

      - name: Build and push image to Harbor
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.HARBOR_REGISTRY }}/aaa/service-a:${{ steps.version.outputs.version }}
            ${{ secrets.HARBOR_REGISTRY }}/aaa/service-a:latest

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ${{ steps.changelog.outputs.changelog }}
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
