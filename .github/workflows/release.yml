name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (optional, e.g. v1.2.3). If not provided, patch version will auto-increment."
        required: false

jobs:
  create-tag-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release version
        id: version
        run: |
          VERSION_INPUT="${{ github.event.inputs.version }}"
          if [ -n "$VERSION_INPUT" ]; then
            echo "Using manually provided version: $VERSION_INPUT"
            echo "version=$VERSION_INPUT" >> $GITHUB_OUTPUT
          else
            latest_tag=$(git tag --list 'v*' --sort=-v:refname | head -n1)
            if [ -z "$latest_tag" ]; then
              new_version="v1.0.0"
            else
              IFS='.' read -r major minor patch <<< "${latest_tag#v}"
              patch=$((patch + 1))
              new_version="v${major}.${minor}.${patch}"
            fi
            echo "Auto-incremented version: $new_version"
            echo "version=$new_version" >> $GITHUB_OUTPUT
          fi

      - name: Generate CHANGELOG
        uses: metcalfc/changelog-generator@v4
        with:
          changelog_path: CHANGELOG.md
          config_path: .chglog/config.yml
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: Commit and push CHANGELOG
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md
          git commit -m "chore: update CHANGELOG for ${{ github.event.inputs.version }}" || echo "No changes to commit"
          git push origin main

      - name: Create tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ github.event.inputs.version }}
          git push origin ${{ github.event.inputs.version }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Build JAR
        run: mvn clean package -DskipTests

      - name: Build and push image to Harbor
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.HARBOR_REGISTRY }}/aaa/service-a:${{ github.event.inputs.version }}
            ${{ secrets.HARBOR_REGISTRY }}/aaa/service-a:latest

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}